@model ITHelpDesk.Models.Ticket
@using ITHelpDesk.Models
@using ITHelpDesk.ViewModels

@{
    ViewData["Title"] = "Manager Approval - System Change";
    var ticketNumber = $"HD-{Model.Id:D6}";
    var details = SystemChangeRequestDetailsViewModel.Parse(Model.Description);
}

<div class="row justify-content-center">
    <div class="col-12 col-xl-10 col-xxl-9">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4 p-lg-5">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-4">
                    <div>
                        <h1 class="h3 fw-semibold text-primary mb-1">
                            <i class="fa-solid fa-check-circle me-2"></i>Manager Approval - System Change
                        </h1>
                        <p class="text-secondary mb-0">Ticket: @ticketNumber</p>
                    </div>
                    <a asp-action="Details" asp-controller="Tickets" asp-route-id="@Model.Id" class="btn btn-outline-secondary">
                        <i class="fa-solid fa-arrow-left-long me-2"></i>Back to Ticket
                    </a>
                </div>

                <div class="mb-4">
                    <h5 class="fw-semibold text-dark mb-3 pb-2 border-bottom">
                        <i class="fa-solid fa-gear me-2 text-primary"></i>Change Summary
                    </h5>
                    <div class="mb-3">
                        <h4 class="h5 text-primary mb-3">@Model.Title</h4>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card bg-light border-0 h-100">
                                <div class="card-body">
                                    <h6 class="text-secondary mb-2"><i class="fa-solid fa-user me-2"></i>Requester Information</h6>
                                    <p class="mb-1"><strong>Name:</strong> @details.RequesterName</p>
                                    <p class="mb-1"><strong>Department:</strong> @details.Department</p>
                                    <p class="mb-0"><strong>Phone:</strong> @details.PhoneNumber</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light border-0 h-100">
                                <div class="card-body">
                                    <h6 class="text-secondary mb-2"><i class="fa-solid fa-chart-line me-2"></i>Impact Assessment</h6>
                                    <p class="mb-1"><strong>Change Type:</strong> 
                                        @if (!string.IsNullOrEmpty(details.ChangeType))
                                        {
                                            <span class="badge bg-secondary">@details.ChangeType</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted small">Not specified</span>
                                        }
                                    </p>
                                    <p class="mb-1"><strong>Priority:</strong> 
                                        @if (!string.IsNullOrEmpty(details.ChangePriority))
                                        {
                                            <span class="badge bg-secondary">@details.ChangePriority</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted small">Not specified</span>
                                        }
                                    </p>
                                    <p class="mb-0"><strong>Impact Level:</strong> 
                                        @if (!string.IsNullOrEmpty(details.ChangeImpact))
                                        {
                                            <span class="badge bg-secondary">@details.ChangeImpact</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted small">Not specified</span>
                                        }
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="text-secondary mb-2"><i class="fa-solid fa-file-lines me-2"></i>Change Description</h6>
                                <p class="mb-0 text-muted">@details.ChangeDescription</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="text-secondary mb-2"><i class="fa-solid fa-question-circle me-2"></i>Change Reason</h6>
                                <p class="mb-0 text-muted">@details.ChangeReason</p>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mt-3">
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <h6 class="text-secondary mb-2"><i class="fa-solid fa-server me-2"></i>Affected Assets</h6>
                                    <p class="mb-0 text-muted small">@details.AffectedAssets</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <h6 class="text-secondary mb-2"><i class="fa-solid fa-wrench me-2"></i>Implementer</h6>
                                    <p class="mb-1 text-muted"><strong>@details.ImplementerName</strong></p>
                                    <p class="mb-0 text-muted small"><i class="fa-regular fa-calendar me-1"></i>@details.ExecutionDate</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <h6 class="text-secondary mb-2"><i class="fa-solid fa-clock me-2"></i>Status</h6>
                                    <p class="mb-0"><span class="badge bg-primary">@Model.Status</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="accordion" id="planAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#implementationPlan">
                                        <i class="fa-solid fa-list-check me-2"></i>Implementation Plan
                                    </button>
                                </h2>
                                <div id="implementationPlan" class="accordion-collapse collapse show" data-bs-parent="#planAccordion">
                                    <div class="accordion-body">
                                        <p class="mb-0 text-muted">@details.ImplementationPlan</p>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#backoutPlan">
                                        <i class="fa-solid fa-rotate-left me-2"></i>Backout Plan
                                    </button>
                                </h2>
                                <div id="backoutPlan" class="accordion-collapse collapse" data-bs-parent="#planAccordion">
                                    <div class="accordion-body">
                                        <p class="mb-0 text-muted">@details.BackoutPlan</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                @if (Model.Attachments.Any())
                {
                    <div class="mb-4">
                        <h5 class="fw-semibold text-dark mb-3 pb-2 border-bottom">
                            <i class="fa-solid fa-paperclip me-2 text-primary"></i>Attachments
                        </h5>
                        <div class="list-group">
                            @foreach (var attachment in Model.Attachments)
                            {
                                <a href="~/@attachment.FilePath" target="_blank" class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between align-items-center">
                                        <div>
                                            <i class="fa-solid fa-file me-2"></i>
                                            <strong>@attachment.FileName</strong>
                                        </div>
                                        <small class="text-muted">Uploaded @attachment.UploadTime.ToLocalTime():g</small>
                                    </div>
                                </a>
                            }
                        </div>
                    </div>
                }

                <div class="mb-4">
                    <form method="post" asp-action="ApproveConfirmed" asp-controller="SystemChangeRequests" asp-route-id="@Model.Id" class="mb-3">
                        @Html.AntiForgeryToken()
                        <div class="mb-3">
                            <label for="approveComment" class="form-label fw-semibold">Comment (optional)</label>
                            <textarea name="comment" id="approveComment" class="form-control" rows="3" placeholder="Add any notes for the record..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fa-solid fa-check me-2"></i>Approve and Forward to Security
                        </button>
                    </form>

                    <form method="post" asp-action="Reject" asp-controller="SystemChangeRequests" asp-route-id="@Model.Id" onsubmit="return confirm('Are you sure you want to reject this request?');">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-danger">
                            <i class="fa-solid fa-times me-2"></i>Reject Request
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
