@model TicketsIndexViewModel

@using Microsoft.AspNetCore.Html
@using Microsoft.AspNetCore.Mvc.Rendering
@using Microsoft.AspNetCore.Routing

@{
    ViewData["Title"] = "All Tickets";

    string PriorityBadge(TicketPriority priority) => priority switch
    {
        TicketPriority.High => "bg-danger",
        TicketPriority.Medium => "bg-warning text-dark",
        TicketPriority.Low => "bg-success",
        _ => "bg-secondary"
    };

    string StatusBadge(TicketStatus status) => status switch
    {
        TicketStatus.New => "bg-primary",
        TicketStatus.InProgress => "bg-info text-dark",
        TicketStatus.Resolved => "bg-success",
        TicketStatus.Rejected => "bg-secondary",
        _ => "bg-light text-dark"
    };

    var baseRouteValues = Model.Query.ToRouteValues(includePagination: false);
    var exportRoute = baseRouteValues.ToDictionary(
        kvp => kvp.Key,
        kvp => kvp.Value?.ToString() ?? string.Empty);
}

<div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3 mb-4">
    <div>
        <h1 class="display-6 fw-semibold text-primary mb-1">
            <i class="fa-solid fa-clipboard-list-check me-2"></i>Ticket Dashboard
        </h1>
        <p class="text-secondary mb-0">Monitor, prioritize, and resolve IT support requests.</p>
    </div>
    <div class="d-flex flex-wrap gap-2">
        <a asp-action="ExportCsv" asp-all-route-data="exportRoute" class="btn btn-outline-secondary">
            <i class="fa-solid fa-file-export me-2"></i>Export CSV
        </a>
    </div>
</div>

<div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <input type="hidden" name="SortBy" value="@Model.Query.SortBy" />
            <input type="hidden" name="SortDirection" value="@Model.Query.SortDirection" />
            <input type="hidden" name="Page" value="1" />

            <div class="col-12 col-md-6 col-lg-2">
                <label class="form-label fw-semibold" for="Status">Status</label>
                <select class="form-select" id="Status" name="Status">
                    <option value="">All</option>
                    @foreach (var option in Model.StatusOptions)
                    {
                        <option value="@option.Value" selected="@option.Selected">@option.Text</option>
                    }
                </select>
            </div>

            <div class="col-12 col-md-6 col-lg-2">
                <label class="form-label fw-semibold" for="Priority">Priority</label>
                <select class="form-select" id="Priority" name="Priority">
                    <option value="">All</option>
                    @foreach (var option in Model.PriorityOptions)
                    {
                        <option value="@option.Value" selected="@option.Selected">@option.Text</option>
                    }
                </select>
            </div>

            <div class="col-12 col-md-6 col-lg-2">
                <label class="form-label fw-semibold" for="Department">Department</label>
                <select class="form-select" id="Department" name="Department">
                    <option value="">All</option>
                    @foreach (var option in Model.DepartmentOptions)
                    {
                        <option value="@option.Value" selected="@option.Selected">@option.Text</option>
                    }
                </select>
            </div>

            <div class="col-12 col-md-6 col-lg-2">
                <label class="form-label fw-semibold" for="From">Created From</label>
                <input type="date" class="form-control" id="From" name="From" value="@(Model.Query.From?.ToString("yyyy-MM-dd"))" />
            </div>

            <div class="col-12 col-md-6 col-lg-2">
                <label class="form-label fw-semibold" for="To">Created To</label>
                <input type="date" class="form-control" id="To" name="To" value="@(Model.Query.To?.ToString("yyyy-MM-dd"))" />
            </div>

            <div class="col-12 col-md-6 col-lg-2">
                <label class="form-label fw-semibold" for="PageSize">Page Size</label>
                <select class="form-select" id="PageSize" name="PageSize">
                    @foreach (var size in new[] { 10, 20, 50 })
                    {
                        <option value="@size" selected="@(Model.Query.PageSize == size)">@size</option>
                    }
                </select>
            </div>

            <div class="col-12 col-md-6 col-lg-3">
                <label class="form-label fw-semibold" for="Requester">Requester</label>
                <input type="text" class="form-control" id="Requester" name="Requester" value="@Model.Query.Requester" placeholder="Name or email" />
            </div>

            <div class="col-12 col-md-6 col-lg-3">
                <label class="form-label fw-semibold" for="Assignee">Assignee</label>
                <input type="text" class="form-control" id="Assignee" name="Assignee" value="@Model.Query.Assignee" placeholder="Name or email" />
            </div>

            <div class="col-12 col-lg-6 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="fa-solid fa-filter me-2"></i>Apply Filters
                </button>
                <a asp-action="Index" class="btn btn-outline-secondary">
                    <i class="fa-solid fa-rotate-right me-2"></i>Reset
                </a>
            </div>
        </form>

        @{ var activeFilters = Model.Query.ToRouteValues(includePagination: false)
                .Where(kvp => !string.IsNullOrWhiteSpace(kvp.Value?.ToString()))
                .ToList(); }

        @if (activeFilters.Any())
        {
            <div class="mt-3">
                <span class="text-secondary small text-uppercase fw-semibold me-2">Active Filters:</span>
                @foreach (var filter in activeFilters)
                {
                    <span class="badge bg-light text-secondary border me-2">@($"{filter.Key}: {filter.Value}")</span>
                }
            </div>
        }
    </div>
</div>

<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th scope="col">@SortLink("createdAt", "Ticket #")</th>
                        <th scope="col">@SortLink("title", "Title")</th>
                        <th scope="col">@SortLink("department", "Department")</th>
                        <th scope="col">@SortLink("priority", "Priority")</th>
                        <th scope="col">@SortLink("status", "Status")</th>
                        <th scope="col">Requester</th>
                        <th scope="col">Assignee</th>
                        <th scope="col" class="text-nowrap">@SortLink("createdAt", "Created At")</th>
                        <th scope="col" class="text-nowrap text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                @if (!Model.Result.Items.Any())
                {
                    <tr>
                        <td colspan="9" class="py-5 text-center text-secondary">
                            <i class="fa-regular fa-envelope-open-text fa-3x mb-3 text-muted"></i>
                            <div class="fw-semibold">No tickets match the current filters.</div>
                            <p class="mb-3">Adjust your filters or broaden your search criteria.</p>
                        </td>
                    </tr>
                }
                else
                {
                    foreach (var ticket in Model.Result.Items)
                    {
                        var ticketNumber = $"HD-{ticket.Id:D6}";
                        <tr>
                            <td class="fw-semibold text-secondary">@ticketNumber</td>
                            <td>
                                <a asp-action="Details" asp-route-id="@ticket.Id" class="text-decoration-none fw-semibold">@ticket.Title</a>
                                <div class="text-muted small d-md-none">Created @ticket.CreatedAt.ToLocalTime():g</div>
                            </td>
                            <td>@ticket.Department</td>
                            <td><span class="badge rounded-pill @PriorityBadge(ticket.Priority)">@ticket.Priority</span></td>
                            <td><span class="badge rounded-pill @StatusBadge(ticket.Status)">@ticket.Status</span></td>
                            <td>@ticket.CreatedBy?.FullName</td>
                            <td>@(ticket.AssignedTo?.FullName ?? "Unassigned")</td>
                            <td>@ticket.CreatedAt.ToLocalTime():g</td>
                            <td class="text-nowrap text-end">
                                <a class="btn btn-primary btn-sm me-2" asp-action="Details" asp-route-id="@ticket.Id">View Details</a>
                                @if (User.IsInRole("Admin") || User.IsInRole("Support"))
                                {
                                    <a class="btn btn-outline-secondary btn-sm" asp-action="ChangeStatus" asp-route-id="@ticket.Id">Update Status</a>
                                }
                            </td>
                        </tr>
                    }
                }
                </tbody>
            </table>
        </div>
    </div>
</div>

@if (Model.Result.TotalPages > 1)
{
    <nav class="mt-4" aria-label="Tickets pagination">
        <ul class="pagination justify-content-end">
            @for (var pageNumber = 1; pageNumber <= Model.Result.TotalPages; pageNumber++)
            {
                var route = baseRouteValues
                    .ToDictionary(
                        kvp => kvp.Key,
                        kvp => kvp.Value?.ToString() ?? string.Empty);
                route["Page"] = pageNumber.ToString();
                route["PageSize"] = Model.Query.PageSize.ToString();
                route["SortBy"] = Model.Query.SortBy ?? "createdAt";
                route["SortDirection"] = Model.Query.SortDirection ?? "desc";
                var isActive = pageNumber == Model.Result.Page;
                <li class="page-item @(isActive ? "active" : string.Empty)">
                    <a class="page-link" asp-action="Index" asp-all-route-data="route">@pageNumber</a>
                </li>
            }
        </ul>
    </nav>
}

@functions {
    private IHtmlContent SortLink(string column, string label)
    {
        var currentSort = Model.Query.SortBy?.ToLowerInvariant();
        var currentDir = Model.Query.SortDirection ?? "desc";
        var isActive = string.Equals(currentSort, column, StringComparison.OrdinalIgnoreCase);
        var nextDir = isActive && currentDir == "asc" ? "desc" : "asc";

        var route = new RouteValueDictionary(Model.Query.ToRouteValues(includePagination: false))
        {
            ["SortBy"] = column,
            ["SortDirection"] = nextDir,
            ["Page"] = 1,
            ["PageSize"] = Model.Query.PageSize
        };

        var anchor = new TagBuilder("a");
        anchor.AddCssClass("text-decoration-none text-dark fw-semibold small text-uppercase");
        anchor.Attributes["asp-action"] = "Index";
        foreach (var kvp in route)
        {
            anchor.Attributes[$"asp-route-{kvp.Key}"] = kvp.Value?.ToString();
        }
        anchor.InnerHtml.Append(label);

        var builder = new HtmlContentBuilder();
        builder.AppendHtml(anchor);

        if (isActive)
        {
            var iconClass = currentDir == "asc"
                ? "fa-solid fa-arrow-up-short-wide"
                : "fa-solid fa-arrow-down-wide-short";
            builder.AppendHtml($" <i class=\"{iconClass} text-secondary ms-1\"></i>");
        }

        return builder;
    }
}

