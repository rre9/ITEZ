@model ServiceRequestApprovalViewModel
@using ITHelpDesk.Models

@{
    ViewData["Title"] = "Approve Service Request";
    var ticketNumber = $"HD-{Model.TicketId:D6}";
}

<div class="row justify-content-center">
    <div class="col-12 col-xl-10 col-xxl-9">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4 p-lg-5">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-4">
                    <div>
                        <h1 class="h3 fw-semibold text-info mb-1">
                            <i class="fa-solid fa-check-circle me-2"></i>Approve Service Request
                        </h1>
                        <p class="text-secondary mb-0">Ticket: @ticketNumber</p>
                    </div>
                    <a asp-action="Details" asp-route-id="@Model.TicketId" class="btn btn-outline-secondary">
                        <i class="fa-solid fa-arrow-left-long me-2"></i>Back to Ticket
                    </a>
                </div>

                @if (!Model.IsAuthorizedManager && !Model.IsReadOnly)
                {
                    <div class="alert alert-warning" role="alert">
                        <i class="fa-solid fa-exclamation-triangle me-2"></i>
                        <strong>You are not authorized to approve this request.</strong>
                        <p class="mb-0 mt-2">Only the selected Direct Manager can approve or reject this service request.</p>
                    </div>
                }

                @if (Model.ServiceRequest.ManagerApprovalStatus != ApprovalStatus.Pending)
                {
                    var statusClass = Model.ServiceRequest.ManagerApprovalStatus == ApprovalStatus.Approved ? "alert-success" : "alert-danger";
                    var statusText = Model.ServiceRequest.ManagerApprovalStatus == ApprovalStatus.Approved ? "Approved" : "Rejected";
                    var statusIcon = Model.ServiceRequest.ManagerApprovalStatus == ApprovalStatus.Approved ? "fa-check-circle" : "fa-times-circle";
                    <div class="alert @statusClass" role="alert">
                        <i class="fa-solid @statusIcon me-2"></i>
                        <strong>This request has been @statusText</strong>
                        @if (Model.ServiceRequest.ManagerApprovalDate.HasValue)
                        {
                            <span class="d-block mt-1">by @Model.ServiceRequest.ManagerApprovalName on @Model.ServiceRequest.ManagerApprovalDate.Value.ToLocalTime().ToString("f")</span>
                        }
                    </div>
                }

                <!-- Applicant Information -->
                <div class="mb-4">
                    <h5 class="fw-semibold text-dark mb-3 pb-2 border-bottom">
                        <i class="fa-solid fa-user me-2 text-primary"></i>Applicant Information
                    </h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold text-secondary">Employee Name</label>
                            <div class="form-control-plaintext">@Model.ServiceRequest.EmployeeName</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold text-secondary">Department</label>
                            <div class="form-control-plaintext">@Model.ServiceRequest.Department</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold text-secondary">Job Title</label>
                            <div class="form-control-plaintext">@Model.ServiceRequest.JobTitle</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold text-secondary">Request Date</label>
                            <div class="form-control-plaintext">@Model.ServiceRequest.RequestDate.ToString("yyyy-MM-dd HH:mm")</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold text-secondary">Selected Direct Manager</label>
                            <div class="form-control-plaintext">@(Model.ServiceRequest.SelectedManager?.FullName ?? "Unknown")</div>
                        </div>
                    </div>
                </div>

                <!-- Service Request Details -->
                <div class="mb-4">
                    <h5 class="fw-semibold text-dark mb-3 pb-2 border-bottom">
                        <i class="fa-solid fa-file-lines me-2 text-primary"></i>Service Request Details
                    </h5>
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label fw-semibold text-secondary">Description of Requested Social Media Usage</label>
                            <div class="form-control-plaintext border p-3 bg-light rounded">@Model.ServiceRequest.UsageDescription</div>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-semibold text-secondary">Reason for Request</label>
                            <div class="form-control-plaintext border p-3 bg-light rounded">@Model.ServiceRequest.UsageReason</div>
                        </div>
                    </div>
                </div>

                <!-- Responsibility Acknowledgment -->
                <div class="mb-4">
                    <h5 class="fw-semibold text-dark mb-3 pb-2 border-bottom">
                        <i class="fa-solid fa-gavel me-2 text-primary"></i>Responsibility Acknowledgment
                    </h5>
                    <div class="alert alert-info mb-0">
                        <p class="mb-0"><strong>I, the undersigned, acknowledge that in consideration of being granted permission to access and use social media platforms on company devices or through Yaqeen's corporate internet network for the purposes stated above, I hereby declare and undertake the following:</strong></p>
                        <ol class="mb-0 mt-3 ps-4">
                            <li class="mb-2">I commit not to publish or disclose any company-related content, and I understand that this access is granted strictly for the purposes stated above, and I will perform my duties with the highest professional standards.</li>
                            <li class="mb-2">I commit to complying with all applicable laws, regulations, and instructions related to such usage at all times.</li>
                            <li class="mb-2">I commit to complying with all Yaqeen company policies at all times.</li>
                            <li class="mb-2">I fully understand that the use of any illegal and/or inappropriate methods through this access permit is strictly prohibited.</li>
                            <li class="mb-0">I fully understand that any violation of these instructions or any rules or directives issued by Yaqeen (written or verbal) related to such usage may subject the employee to disciplinary actions.</li>
                        </ol>
                    </div>
                    <div class="mt-3">
                        <label class="form-label fw-semibold text-secondary">Acknowledged</label>
                        <div class="form-control-plaintext">
                            <i class="fa-solid fa-@(Model.ServiceRequest.Acknowledged ? "check text-success" : "times text-danger") me-2"></i>
                            @(Model.ServiceRequest.Acknowledged ? "Yes" : "No")
                        </div>
                    </div>
                </div>

                <!-- Signature Information -->
                <div class="mb-4">
                    <h5 class="fw-semibold text-dark mb-3 pb-2 border-bottom">
                        <i class="fa-solid fa-signature me-2 text-primary"></i>Signature Information
                    </h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold text-secondary">Signature Name</label>
                            <div class="form-control-plaintext">@Model.ServiceRequest.SignatureName</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold text-secondary">Signature Job Title</label>
                            <div class="form-control-plaintext">@Model.ServiceRequest.SignatureJobTitle</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold text-secondary">Signature Date</label>
                            <div class="form-control-plaintext">@Model.ServiceRequest.SignatureDate.ToString("yyyy-MM-dd HH:mm")</div>
                        </div>
                    </div>
                </div>

                <!-- Attachments -->
                @if (Model.Ticket.Attachments.Any())
                {
                    <div class="mb-4">
                        <h5 class="fw-semibold text-dark mb-3 pb-2 border-bottom">
                            <i class="fa-solid fa-paperclip me-2 text-primary"></i>Attachments
                        </h5>
                        <div class="list-group">
                            @foreach (var attachment in Model.Ticket.Attachments)
                            {
                                <a href="~/@attachment.FilePath" target="_blank" class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between align-items-center">
                                        <div>
                                            <i class="fa-solid fa-file me-2"></i>
                                            <strong>@attachment.FileName</strong>
                                        </div>
                                        <small class="text-muted">Uploaded @attachment.UploadTime.ToLocalTime().ToString("g")</small>
                                    </div>
                                </a>
                            }
                        </div>
                    </div>
                }

                <!-- Approval Section -->
                @if (Model.IsAuthorizedManager && Model.ServiceRequest.ManagerApprovalStatus == ApprovalStatus.Pending)
                {
                    <div class="mb-4">
                        <h5 class="fw-semibold text-dark mb-3 pb-2 border-bottom">
                            <i class="fa-solid fa-signature me-2 text-primary"></i>Manager Approval
                        </h5>
                        <form method="post" asp-action="ApproveServiceRequest" asp-route-id="@Model.TicketId" class="mb-3">
                            @Html.AntiForgeryToken()
                            <div class="mb-3">
                                <label for="approveComment" class="form-label fw-semibold">Comment (Optional)</label>
                                <textarea name="comment" id="approveComment" class="form-control" rows="3" placeholder="Add any comments or notes..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fa-solid fa-check me-2"></i>Approve Request
                            </button>
                        </form>

                        <form method="post" asp-action="RejectServiceRequest" asp-route-id="@Model.TicketId">
                            @Html.AntiForgeryToken()
                            <div class="mb-3">
                                <label for="rejectComment" class="form-label fw-semibold">Rejection Reason <span class="text-danger">*</span></label>
                                <textarea name="comment" id="rejectComment" class="form-control" rows="3" placeholder="Please provide a reason for rejection..." required></textarea>
                                <div class="form-text">A comment is required when rejecting a request.</div>
                            </div>
                            <button type="submit" class="btn btn-danger btn-lg">
                                <i class="fa-solid fa-times me-2"></i>Reject Request
                            </button>
                        </form>
                    </div>
                }
                else if (Model.ServiceRequest.ManagerApprovalStatus != ApprovalStatus.Pending)
                {
                    <div class="mb-4">
                        <h5 class="fw-semibold text-dark mb-3 pb-2 border-bottom">
                            <i class="fa-solid fa-signature me-2 text-primary"></i>Manager Approval Decision
                        </h5>
                        <div class="alert @(Model.ServiceRequest.ManagerApprovalStatus == ApprovalStatus.Approved ? "alert-success" : "alert-danger")" role="alert">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Status:</strong> @Model.ServiceRequest.ManagerApprovalStatus
                                </div>
                                @if (Model.ServiceRequest.ManagerApprovalDate.HasValue)
                                {
                                    <div class="col-md-6">
                                        <strong>Date:</strong> @Model.ServiceRequest.ManagerApprovalDate.Value.ToLocalTime().ToString("f")
                                    </div>
                                }
                                @if (!string.IsNullOrWhiteSpace(Model.ServiceRequest.ManagerApprovalName))
                                {
                                    <div class="col-md-6 mt-2">
                                        <strong>Approved By:</strong> @Model.ServiceRequest.ManagerApprovalName
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }

                <!-- Audit History -->
                @if (Model.Logs.Any())
                {
                    <div class="mb-4">
                        <h5 class="fw-semibold text-dark mb-3 pb-2 border-bottom">
                            <i class="fa-solid fa-history me-2 text-primary"></i>Audit History
                        </h5>
                        <div class="timeline">
                            @foreach (var log in Model.Logs)
                            {
                                <div class="border-start border-3 ps-3 mb-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <strong>@log.Action</strong>
                                            @if (!string.IsNullOrWhiteSpace(log.Notes))
                                            {
                                                <p class="mb-1 text-secondary small">@log.Notes</p>
                                            }
                                            <small class="text-muted">
                                                <i class="fa-solid fa-user me-1"></i>@log.PerformedBy?.FullName
                                                <i class="fa-solid fa-clock ms-2 me-1"></i>@log.Timestamp.ToLocalTime().ToString("f")
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
    </script>
}

