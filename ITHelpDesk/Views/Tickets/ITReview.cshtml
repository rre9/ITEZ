@model ITReviewViewModel
@using ITHelpDesk.Models

@{
    ViewData["Title"] = "IT Review";
    var ticketNumber = $"HD-{Model.TicketId:D6}";
}

<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-4">
    <div>
        <h1 class="display-6 fw-semibold text-primary mb-1">
            <i class="fa-solid fa-gavel me-2"></i>IT Review
        </h1>
        <p class="text-secondary mb-0">Ticket: @ticketNumber</p>
    </div>
    <a asp-action="Index" class="btn btn-outline-secondary">
        <i class="fa-solid fa-arrow-left-long me-2"></i>Back to Dashboard
    </a>
</div>

@if (!Model.CanReview && Model.Ticket.Status == TicketStatus.InProgress)
{
    <div class="alert alert-warning" role="alert">
        <i class="fa-solid fa-exclamation-triangle me-2"></i>
        <strong>This request has already been reviewed.</strong>
        <p class="mb-0 mt-2">You can view the details below but cannot make changes.</p>
    </div>
}

@if (Model.Ticket.Status == TicketStatus.Resolved || Model.Ticket.Status == TicketStatus.Rejected)
{
    var statusClass = Model.Ticket.Status == TicketStatus.Resolved ? "alert-success" : "alert-danger";
    var statusText = Model.Ticket.Status == TicketStatus.Resolved ? "Resolved" : "Rejected";
    var statusIcon = Model.Ticket.Status == TicketStatus.Resolved ? "fa-check-circle" : "fa-times-circle";
    <div class="alert @statusClass" role="alert">
        <i class="fa-solid @statusIcon me-2"></i>
        <strong>Request @statusText</strong>
        @{
            var completionLog = Model.Logs.FirstOrDefault(l => l.Action == "IT Approved Review" || l.Action == "IT Rejected Review");
        }
        @if (completionLog != null)
        {
            <span class="d-block mt-1">by @completionLog.PerformedBy?.FullName on @completionLog.Timestamp.ToLocalTime().ToString("f")</span>
        }
    </div>
}

<div class="row g-4">
    <!-- Left Side: Read-only Ticket and Request Details -->
    <div class="col-12 col-xl-7">
        <!-- Ticket Details -->
        @await Html.PartialAsync("_TicketDetailsReadOnly", Model.Ticket)
        
        @if (Model.AccessRequest != null)
        {
            <!-- Access Request Details -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-white border-0 pb-0">
                    <h2 class="h5 fw-semibold mb-0">
                        <i class="fa-solid fa-file-signature me-2 text-primary"></i>Access Request Details
                    </h2>
                </div>
                <div class="card-body">
                    @await Html.PartialAsync("_AccessRequestDetailsReadOnly", Model.AccessRequest)
                </div>
            </div>

            <!-- Approval Statuses -->
            @if (Model.AccessRequest.ManagerApprovalStatus == ApprovalStatus.Approved)
            {
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-header bg-white border-0 pb-0">
                        <h2 class="h5 fw-semibold mb-0">
                            <i class="fa-solid fa-user-check me-2 text-primary"></i>Manager Approval
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success mb-0">
                            <strong>Status:</strong> Approved
                            @if (Model.AccessRequest.ManagerApprovalDate.HasValue)
                            {
                                <span class="d-block mt-1"><strong>Date:</strong> @Model.AccessRequest.ManagerApprovalDate.Value.ToLocalTime().ToString("f")</span>
                            }
                            @if (!string.IsNullOrWhiteSpace(Model.AccessRequest.ManagerApprovalName))
                            {
                                <span class="d-block mt-1"><strong>Approved By:</strong> @Model.AccessRequest.ManagerApprovalName</span>
                            }
                        </div>
                    </div>
                </div>
            }

            @if (Model.AccessRequest.SecurityApprovalStatus == ApprovalStatus.Approved)
            {
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-header bg-white border-0 pb-0">
                        <h2 class="h5 fw-semibold mb-0">
                            <i class="fa-solid fa-shield-halved me-2 text-primary"></i>Security Approval
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success mb-0">
                            <strong>Status:</strong> Approved
                            @if (Model.AccessRequest.SecurityApprovalDate.HasValue)
                            {
                                <span class="d-block mt-1"><strong>Date:</strong> @Model.AccessRequest.SecurityApprovalDate.Value.ToLocalTime().ToString("f")</span>
                            }
                            @if (!string.IsNullOrWhiteSpace(Model.AccessRequest.SecurityApprovalName))
                            {
                                <span class="d-block mt-1"><strong>Approved By:</strong> @Model.AccessRequest.SecurityApprovalName</span>
                            }
                        </div>
                    </div>
                </div>
            }
        }
        else if (Model.ServiceRequest != null)
        {
            <!-- Service Request Details -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-white border-0 pb-0">
                    <h2 class="h5 fw-semibold mb-0">
                        <i class="fa-solid fa-file-signature me-2 text-primary"></i>Service Request Details
                    </h2>
                </div>
                <div class="card-body">
                    @await Html.PartialAsync("_ServiceRequestDetailsReadOnly", Model.ServiceRequest)
                </div>
            </div>

            <!-- Approval Statuses -->
            @if (Model.ServiceRequest.ManagerApprovalStatus == ApprovalStatus.Approved)
            {
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-header bg-white border-0 pb-0">
                        <h2 class="h5 fw-semibold mb-0">
                            <i class="fa-solid fa-user-check me-2 text-primary"></i>Manager Approval
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success mb-0">
                            <strong>Status:</strong> Approved
                            @if (Model.ServiceRequest.ManagerApprovalDate.HasValue)
                            {
                                <span class="d-block mt-1"><strong>Date:</strong> @Model.ServiceRequest.ManagerApprovalDate.Value.ToLocalTime().ToString("f")</span>
                            }
                            @if (!string.IsNullOrWhiteSpace(Model.ServiceRequest.ManagerApprovalName))
                            {
                                <span class="d-block mt-1"><strong>Approved By:</strong> @Model.ServiceRequest.ManagerApprovalName</span>
                            }
                        </div>
                    </div>
                </div>
            }

            @if (Model.ServiceRequest.SecurityApprovalStatus == ApprovalStatus.Approved)
            {
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-header bg-white border-0 pb-0">
                        <h2 class="h5 fw-semibold mb-0">
                            <i class="fa-solid fa-shield-halved me-2 text-primary"></i>Security Approval
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success mb-0">
                            <strong>Status:</strong> Approved
                            @if (Model.ServiceRequest.SecurityApprovalDate.HasValue)
                            {
                                <span class="d-block mt-1"><strong>Date:</strong> @Model.ServiceRequest.SecurityApprovalDate.Value.ToLocalTime().ToString("f")</span>
                            }
                            @if (!string.IsNullOrWhiteSpace(Model.ServiceRequest.SecurityApprovalName))
                            {
                                <span class="d-block mt-1"><strong>Approved By:</strong> @Model.ServiceRequest.SecurityApprovalName</span>
                            }
                        </div>
                    </div>
                </div>
            }
        }
    </div>

    <!-- Right Side: Decision Panel -->
    <div class="col-12 col-xl-5">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pb-0">
                <h2 class="h5 fw-semibold mb-0">
                    <i class="fa-solid fa-gavel me-2 text-primary"></i>Decision Panel
                </h2>
            </div>
            <div class="card-body">
                @if (Model.CanReview && Model.Ticket.Status == TicketStatus.InProgress)
                {
                    <!-- Approve Form -->
                    <form method="post" asp-action="ApproveITReview" asp-route-id="@Model.TicketId" enctype="multipart/form-data" class="mb-4">
                        @Html.AntiForgeryToken()
                        
                        <div class="mb-3">
                            <label for="approveComment" class="form-label fw-semibold">Comment <span class="text-danger">*</span></label>
                            <textarea name="comment" id="approveComment" class="form-control" rows="4" required placeholder="Please provide your review comment..."></textarea>
                            <div class="form-text">Comment is required.</div>
                        </div>

                        <div class="mb-3">
                            <label for="approveAttachments" class="form-label fw-semibold">Attachments <span class="text-muted small">(Optional)</span></label>
                            <input name="attachments" id="approveAttachments" type="file" class="form-control" multiple accept="image/*,.pdf">
                            <div class="form-text">You can upload images or PDF files (max 10MB each).</div>
                        </div>

                        <button type="submit" class="btn btn-success btn-lg w-100">
                            <i class="fa-solid fa-check me-2"></i>Approve → Close (Resolved)
                        </button>
                    </form>

                    <hr class="my-4">

                    <!-- Reject Form -->
                    <form method="post" asp-action="RejectITReview" asp-route-id="@Model.TicketId" enctype="multipart/form-data" onsubmit="return validateRejectForm(this);">
                        @Html.AntiForgeryToken()
                        
                        <div class="mb-3">
                            <label for="rejectComment" class="form-label fw-semibold">Comment <span class="text-danger">*</span></label>
                            <textarea name="comment" id="rejectComment" class="form-control" rows="4" required placeholder="Please provide your rejection comment..."></textarea>
                            <div class="form-text">Comment is required.</div>
                        </div>

                        <div class="mb-3">
                            <label for="rejectAttachments" class="form-label fw-semibold">Attachments <span class="text-muted small">(Optional)</span></label>
                            <input name="attachments" id="rejectAttachments" type="file" class="form-control" multiple accept="image/*,.pdf">
                            <div class="form-text">You can upload images or PDF files (max 10MB each).</div>
                        </div>

                        <button type="submit" class="btn btn-danger btn-lg w-100">
                            <i class="fa-solid fa-times me-2"></i>Reject → Close (Rejected)
                        </button>
                    </form>
                }
                else
                {
                    <!-- Read-only: Show status if already reviewed -->
                    @if (Model.Ticket.Status == TicketStatus.Resolved || Model.Ticket.Status == TicketStatus.Rejected)
                    {
                        var statusClass = Model.Ticket.Status == TicketStatus.Resolved ? "alert-success" : "alert-danger";
                        var statusText = Model.Ticket.Status == TicketStatus.Resolved ? "Resolved" : "Rejected";
                        var statusIcon = Model.Ticket.Status == TicketStatus.Resolved ? "fa-check-circle" : "fa-times-circle";
                        
                        <div class="alert @statusClass mb-0">
                            <i class="fa-solid @statusIcon me-2"></i>
                            <strong>Status: @statusText</strong>
                            @{
                                var completionLog = Model.Logs.FirstOrDefault(l => l.Action == "IT Approved Review" || l.Action == "IT Rejected Review");
                            }
                            @if (completionLog != null)
                            {
                                <span class="d-block mt-2"><strong>Date:</strong> @completionLog.Timestamp.ToLocalTime().ToString("f")</span>
                                <span class="d-block mt-1"><strong>By:</strong> @completionLog.PerformedBy?.FullName</span>
                                @if (!string.IsNullOrWhiteSpace(completionLog.Notes))
                                {
                                    <span class="d-block mt-2"><strong>Comment:</strong> @completionLog.Notes</span>
                                }
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info mb-0">
                            <i class="fa-solid fa-info-circle me-2"></i>
                            <strong>Not Available for Review</strong>
                            <p class="mb-0 mt-2">This request is not available for review at this time.</p>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function validateRejectForm(form) {
            var commentField = form.querySelector('#rejectComment');
            if (!commentField || !commentField.value.trim()) {
                commentField.classList.add('is-invalid');
                return false;
            }
            commentField.classList.remove('is-invalid');
            return confirm('Are you sure you want to reject and close this request? This action cannot be undone.');
        }
    </script>
}

