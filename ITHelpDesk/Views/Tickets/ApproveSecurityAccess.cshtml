@model AccessRequestSecurityApprovalViewModel
@using ITHelpDesk.Models

@{
    ViewData["Title"] = "Security Approval - Access Request";
    var ticketNumber = $"HD-{Model.TicketId:D6}";
}

<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-4">
    <div>
        <h1 class="display-6 fw-semibold text-primary mb-1">
            <i class="fa-solid fa-shield-halved me-2"></i>Security Approval - Access Request
        </h1>
        <p class="text-secondary mb-0">Ticket: @ticketNumber</p>
    </div>
    <a asp-action="MyTasks" class="btn btn-outline-secondary">
        <i class="fa-solid fa-arrow-left-long me-2"></i>Back to Tasks
    </a>
</div>

@if (!Model.CanApprove && Model.AccessRequest.ManagerApprovalStatus == ApprovalStatus.Approved)
{
    <div class="alert alert-warning" role="alert">
        <i class="fa-solid fa-exclamation-triangle me-2"></i>
        <strong>This request has already been reviewed.</strong>
        <p class="mb-0 mt-2">You can view the details below but cannot make changes.</p>
    </div>
}

@if (Model.AccessRequest.ManagerApprovalStatus != ApprovalStatus.Approved)
{
    <div class="alert alert-warning" role="alert">
        <i class="fa-solid fa-exclamation-triangle me-2"></i>
        <strong>Manager Approval Required</strong>
        <p class="mb-0 mt-2">This request cannot be reviewed until the Direct Manager has approved it.</p>
    </div>
}

<div class="row g-4">
    <!-- Left Side: Read-only Ticket and Access Request Details -->
    <div class="col-12 col-xl-7">
        <!-- Ticket Details -->
        @await Html.PartialAsync("_TicketDetailsReadOnly", Model.Ticket)
        
        <!-- Access Request Details -->
        <div class="card border-0 shadow-sm mt-4">
            <div class="card-header bg-white border-0 pb-0">
                <h2 class="h5 fw-semibold mb-0">
                    <i class="fa-solid fa-file-signature me-2 text-primary"></i>Access Request Details
                </h2>
            </div>
            <div class="card-body">
                @await Html.PartialAsync("_AccessRequestDetailsReadOnly", Model.AccessRequest)
            </div>
        </div>

        <!-- Manager Approval Status -->
        @if (Model.AccessRequest.ManagerApprovalStatus == ApprovalStatus.Approved)
        {
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-white border-0 pb-0">
                    <h2 class="h5 fw-semibold mb-0">
                        <i class="fa-solid fa-user-check me-2 text-primary"></i>Manager Approval
                    </h2>
                </div>
                <div class="card-body">
                    <div class="alert alert-success mb-0">
                        <strong>Status:</strong> Approved
                        @if (Model.AccessRequest.ManagerApprovalDate.HasValue)
                        {
                            <span class="d-block mt-1"><strong>Date:</strong> @Model.AccessRequest.ManagerApprovalDate.Value.ToLocalTime().ToString("f")</span>
                        }
                        @if (!string.IsNullOrWhiteSpace(Model.AccessRequest.ManagerApprovalName))
                        {
                            <span class="d-block mt-1"><strong>Approved By:</strong> @Model.AccessRequest.ManagerApprovalName</span>
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Right Side: Decision Panel -->
    <div class="col-12 col-xl-5">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pb-0">
                <h2 class="h5 fw-semibold mb-0">
                    <i class="fa-solid fa-gavel me-2 text-primary"></i>Decision Panel
                </h2>
            </div>
            <div class="card-body">
                @if (Model.CanApprove && Model.AccessRequest.ManagerApprovalStatus == ApprovalStatus.Approved)
                {
                    <!-- Approve Form -->
                    <form method="post" asp-action="ApproveSecurityAccess" asp-route-id="@Model.TicketId" enctype="multipart/form-data" class="mb-4">
                        @Html.AntiForgeryToken()
                        
                        <div class="mb-3">
                            <label asp-for="Comment" class="form-label fw-semibold">Comment <span class="text-danger">*</span></label>
                            <textarea asp-for="Comment" class="form-control" rows="4" required placeholder="Please provide a comment for your approval..."></textarea>
                            <span asp-validation-for="Comment" class="text-danger small"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Attachments" class="form-label fw-semibold">Attachments <span class="text-muted small">(Optional)</span></label>
                            <input asp-for="Attachments" type="file" class="form-control" multiple accept="image/*,.pdf">
                            <div class="form-text">You can upload images or PDF files (max 10MB each).</div>
                            <span asp-validation-for="Attachments" class="text-danger small"></span>
                        </div>

                        <button type="submit" class="btn btn-success btn-lg w-100">
                            <i class="fa-solid fa-check me-2"></i>Approve Request
                        </button>
                    </form>

                    <hr class="my-4">

                    <!-- Reject Form -->
                    <form method="post" asp-action="RejectSecurityAccess" asp-route-id="@Model.TicketId" enctype="multipart/form-data" onsubmit="return validateRejectForm(this);">
                        @Html.AntiForgeryToken()
                        
                        <div class="mb-3">
                            <label for="rejectComment" class="form-label fw-semibold">Rejection Reason <span class="text-danger">*</span></label>
                            <textarea name="comment" id="rejectComment" class="form-control" rows="4" required placeholder="Please provide a reason for rejecting this request..."></textarea>
                            <div class="invalid-feedback">Please provide a reason for rejection.</div>
                        </div>

                        <div class="mb-3">
                            <label for="rejectAttachments" class="form-label fw-semibold">Attachments <span class="text-muted small">(Optional)</span></label>
                            <input name="attachments" id="rejectAttachments" type="file" class="form-control" multiple accept="image/*,.pdf">
                            <div class="form-text">You can upload images or PDF files (max 10MB each).</div>
                        </div>

                        <button type="submit" class="btn btn-danger btn-lg w-100">
                            <i class="fa-solid fa-times me-2"></i>Reject Request
                        </button>
                    </form>
                }
                else
                {
                    <!-- Read-only: Show decision if already made -->
                    @if (Model.AccessRequest.SecurityApprovalStatus != ApprovalStatus.Pending)
                    {
                        var statusClass = Model.AccessRequest.SecurityApprovalStatus == ApprovalStatus.Approved ? "alert-success" : "alert-danger";
                        var statusText = Model.AccessRequest.SecurityApprovalStatus == ApprovalStatus.Approved ? "Approved" : "Rejected";
                        var statusIcon = Model.AccessRequest.SecurityApprovalStatus == ApprovalStatus.Approved ? "fa-check-circle" : "fa-times-circle";
                        
                        <div class="alert @statusClass mb-0">
                            <i class="fa-solid @statusIcon me-2"></i>
                            <strong>Status: @statusText</strong>
                            @if (Model.AccessRequest.SecurityApprovalDate.HasValue)
                            {
                                <span class="d-block mt-2"><strong>Date:</strong> @Model.AccessRequest.SecurityApprovalDate.Value.ToLocalTime().ToString("f")</span>
                            }
                            @if (!string.IsNullOrWhiteSpace(Model.AccessRequest.SecurityApprovalName))
                            {
                                <span class="d-block mt-1"><strong>Reviewed By:</strong> @Model.AccessRequest.SecurityApprovalName</span>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info mb-0">
                            <i class="fa-solid fa-info-circle me-2"></i>
                            <strong>Waiting for Manager Approval</strong>
                            <p class="mb-0 mt-2">This request is pending manager approval before it can be reviewed.</p>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function validateRejectForm(form) {
            var commentField = form.querySelector('#rejectComment');
            if (!commentField || !commentField.value.trim()) {
                commentField.classList.add('is-invalid');
                return false;
            }
            commentField.classList.remove('is-invalid');
            return confirm('Are you sure you want to reject this request? This action cannot be undone.');
        }
    </script>
}

@section Styles {
    <style>
        .timeline-line {
            position: absolute;
            top: 0.5rem;
            bottom: 0.5rem;
            left: 0.5rem;
            width: 2px;
            background-color: rgba(0, 0, 0, 0.1);
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            position: absolute;
            left: -0.1rem;
            top: 0.5rem;
        }
    </style>
}
